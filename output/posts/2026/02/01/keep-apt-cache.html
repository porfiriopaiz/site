<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="../../../../theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="../../../../theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="../../../../theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Porfirio PÃ¡iz">
  <meta name="description" content="Posts and writings by Porfirio PÃ¡iz">

  <link href="https://porfiriopaiz.github.io/site/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="porfirio's blog Atom" />
  <link href="https://porfiriopaiz.github.io/site/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="porfirio's blog RSS" />

<meta name="keywords" content="apt, cache, debian, systemd">

  <title>
    porfirio's blog
&ndash; Keeping Your APT Package Cache Persistent  </title>

  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = savedTheme ? savedTheme : (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="../../../..">
        <img src="https://porfiriopaiz.github.io/site/images/prpd8Vi.png" alt="logo">
      </a>
      <h2><a href="../../../..">porfirio's blog</a></h2>
      <p>(â– _â– Â¬)</p>
      <button id="theme-toggle" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:var(--text-color);">
        <span id="theme-icon">ðŸŒ“</span>
      </button>
      <ul>
        <li><a href="../../../../category/floss.html">floss</a></li>
        <li><a href="../../../../category/gis.html">gis</a></li>
        <li><a href="../../../../category/misc.html">misc</a></li>
        <li><a href="https://fedoraproject.org/wiki/User:Porfiriopaiz" target="_blank">About</a></li>
        <li><a href="https://github.com/porfiriopaiz" target="_blank">Github</a></li>
        <li><a href="https://twitter.com/porfiriopaiz" target="_blank">Twitter</a></li>
        <li><a href="https://plus.google.com/+PorfirioAndresPaizCarrasco" target="_blank">Google+</a></li>
        <li><a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">License</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="../../../..">Index</a> &brvbar; <a href="../../../../archives.html">Archives</a>
      &brvbar; <a href="https://porfiriopaiz.github.io/site/feeds/all.atom.xml">Atom</a>
      &brvbar; <a href="https://porfiriopaiz.github.io/site/feeds/all.rss.xml">RSS</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="../../../../posts/2026/02/01/keep-apt-cache.html">Keeping Your APT Package Cache Persistent</a></h1>
  </div>
  <div class="article_text">
    <p>If <tt class="docutils literal">/var/cache/apt/archives</tt> is empty, it usually means your system is
configured to clean up automatically to save disk space. While this keeps the
system lean, itâ€™s frustrating if you wanted to keep those .deb files for
backups or offline installs.</p>
<p>Here is how to find the culprit and fix it.</p>
<hr class="docutils" />
<div class="section" id="check-the-keep-downloaded-packages-setting">
<h2>Check the &quot;Keep-Downloaded-Packages&quot; Setting</h2>
<p>Modern Debian/Ubuntu systems often have a specific configuration that deletes
packages immediately after installation. You need to ensure this is set to
<tt class="docutils literal">true</tt>.</p>
<p>You can create or edit the configuration file using this <tt class="docutils literal">sed</tt> command:</p>
<div class="highlight"><pre><span></span>sudo<span class="w"> </span>touch<span class="w"> </span>/etc/apt/apt.conf.d/01keep-debs<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;1i Binary::apt::APT::Keep-Downloaded-Packages &quot;true&quot;;&#39;</span><span class="w"> </span>/etc/apt/apt.conf.d/01keep-debs<span class="w"> </span><span class="c1"># Force APT to retain downloaded .deb files</span>
</pre></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If this is set to <tt class="docutils literal">false</tt> (or <tt class="docutils literal">0</tt>), APT deletes the files as soon as the
installation finishes.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="disable-periodic-cleaning-and-automation">
<h2>Disable Periodic Cleaning and Automation</h2>
<p>Debian has a background service called <tt class="docutils literal"><span class="pre">apt-daily</span></tt> that handles automated package maintenance. Even if you tell APT to keep files, the daily maintenance script might be sweeping them away. Modern versions rely on <strong>systemd timers</strong> rather than traditional cron jobs.</p>
<div class="section" id="understanding-apt-timers">
<h3>Understanding APT Timers</h3>
<p>The key components are:</p>
<ul class="simple">
<li><strong>apt-daily.timer</strong>: Triggers the background refresh of package lists.</li>
<li><strong>apt-daily-upgrade.timer</strong>: Triggers the actual download and installation of updates.</li>
</ul>
<p>Check the status of these timers with:</p>
<div class="highlight"><pre><span></span>systemctl<span class="w"> </span>status<span class="w"> </span>apt-daily.timer<span class="w"> </span><span class="c1"># Verify if the daily refresh timer is active</span>
</pre></div>
</div>
<div class="section" id="manual-configuration-via-apt-files">
<h3>Manual Configuration via APT Files</h3>
<p>To ensure configurations are applied regardless of the current state of the file, we use a logic that checks for the file's existence, creates it if missing, and ensures the specific lines are either updated or appended.</p>
<p>For the standard periodic settings in <tt class="docutils literal">10periodic</tt>, use the following block:</p>
<div class="highlight"><pre><span></span><span class="nv">FILE</span><span class="o">=</span>/etc/apt/apt.conf.d/10periodic
sudo<span class="w"> </span>touch<span class="w"> </span><span class="nv">$FILE</span>
grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;APT::Periodic::MaxAge&quot;</span><span class="w"> </span><span class="nv">$FILE</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/APT::Periodic::MaxAge &quot;.*&quot;/APT::Periodic::MaxAge &quot;0&quot;;/&#39;</span><span class="w"> </span><span class="nv">$FILE</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;APT::Periodic::MaxAge &quot;0&quot;;&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="nv">$FILE</span>
grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;APT::Periodic::MaxSize&quot;</span><span class="w"> </span><span class="nv">$FILE</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/APT::Periodic::MaxSize &quot;.*&quot;/APT::Periodic::MaxSize &quot;0&quot;;/&#39;</span><span class="w"> </span><span class="nv">$FILE</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;APT::Periodic::MaxSize &quot;0&quot;;&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="nv">$FILE</span>
</pre></div>
<p>This logic ensures that if the file is missing, it is created; if the lines exist, they are edited to &quot;0&quot;; and if the file exists but lacks these lines, they are appended.</p>
<p>Next, to explicitly force the deactivation of all automated functions, create or update the <tt class="docutils literal"><span class="pre">20auto-upgrades</span></tt> file:</p>
<div class="highlight"><pre><span></span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/apt.conf.d/20auto-upgrades<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
<span class="s">APT::Periodic::Update-Package-Lists &quot;0&quot;;</span>
<span class="s">APT::Periodic::Download-Upgradeable-Packages &quot;0&quot;;</span>
<span class="s">APT::Periodic::AutocleanInterval &quot;0&quot;;</span>
<span class="s">APT::Periodic::Unattended-Upgrade &quot;0&quot;;</span>
<span class="s">EOF</span>
</pre></div>
</div>
<div class="section" id="deactivating-systemd-timers">
<h3>Deactivating Systemd Timers</h3>
<p>Even with the configurations set to zero, systemd timers will still attempt to trigger services. To stop these triggers entirely:</p>
<div class="highlight"><pre><span></span>sudo<span class="w"> </span>systemctl<span class="w"> </span>disable<span class="w"> </span>--now<span class="w"> </span>apt-daily.timer<span class="w"> </span>apt-daily-upgrade.timer<span class="w"> </span><span class="c1"># Stop and disable background APT timers</span>
</pre></div>
</div>
<div class="section" id="final-verification">
<h3>Final Verification</h3>
<p>To confirm that the system will no longer perform automated actions, execute:</p>
<ol class="arabic simple">
<li><strong>Check APT Configuration</strong>:
<tt class="docutils literal"><span class="pre">apt-config</span> dump | grep Periodic</tt> (All variables should be &quot;0&quot;).</li>
<li><strong>Check Active Timers</strong>:
<tt class="docutils literal">systemctl <span class="pre">list-timers</span> | grep apt</tt> (Should return no results).</li>
</ol>
</div>
</div>
<hr class="docutils" />
<div class="section" id="check-for-no-cache-configuration">
<h2>Check for &quot;No-Cache&quot; Configuration</h2>
<p>Some cloud-images or &quot;minimal&quot; installs include a file that redirects the
cache to <tt class="docutils literal">/dev/null</tt>.</p>
<div class="section" id="identify-problematic-files">
<h3>Identify Problematic Files</h3>
<p>Check if you have a file named <tt class="docutils literal"><span class="pre">/etc/apt/apt.conf.d/docker-clean</span></tt> (even if
you aren't in a Docker container) or similar. If you see that line, you can
comment it out using <tt class="docutils literal">sed</tt>:</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span>/etc/apt/apt.conf.d/docker-clean<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;/Dir::Cache::Archives/s/^/#/&#39;</span><span class="w"> </span>/etc/apt/apt.conf.d/docker-clean<span class="w"> </span><span class="c1"># Deactivate dev/null redirect</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="verify-directory-permissions">
<h2>Verify Directory Permissions</h2>
<p>If the directory permissions are incorrect, APT cannot write the files there. Ensure the directory is owned by <strong>root</strong> but accessible to the <strong>_apt</strong> user.</p>
<p>Run the following to reset permissions:</p>
<div class="highlight"><pre><span></span>sudo<span class="w"> </span>chown<span class="w"> </span>root:root<span class="w"> </span>/var/cache/apt/archives
sudo<span class="w"> </span>chmod<span class="w"> </span><span class="m">755</span><span class="w"> </span>/var/cache/apt/archives
sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/var/cache/apt/archives/partial
</pre></div>
</div>
<hr class="docutils" />
<div class="section" id="summary-of-the-apt-cache-path">
<h2>Summary of the APT Cache Path</h2>
<table border="1" class="docutils">
<colgroup>
<col width="46%" />
<col width="54%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Folder</th>
<th class="head">Purpose</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>/var/cache/apt/archives</td>
<td>Where completed .deb downloads are
stored.</td>
</tr>
<tr><td>/var/cache/apt/archives/partial</td>
<td>Where files sit during the download
process.</td>
</tr>
</tbody>
</table>
</div>
<hr class="docutils" />
<div class="section" id="how-to-test-your-changes">
<h2>How to Test Your Changes</h2>
<p>After making these changes, try downloading a package without installing it
to verify the cache is working:</p>
<div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt<span class="w"> </span>update
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>--download-only<span class="w"> </span>wget
ls<span class="w"> </span>/var/cache/apt/archives<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>wget
</pre></div>
<p>By following these steps, you gain absolute manual control over your system,
preventing unexpected resource blocks and ensuring your local package archive
remains persistent for offline use!</p>
</div>

  </div>
  <div class="article_meta">
    <p>Posted on: Sun 01 February 2026</p>
    <p>Category: <a href="../../../../category/floss.html">floss</a>
 &ndash; Tags:
      <a href="../../../../tag/apt.html">apt</a>,      <a href="../../../../tag/cache.html">cache</a>,      <a href="../../../../tag/debian.html">debian</a>,      <a href="../../../../tag/systemd.html">systemd</a>    </p>
  </div>

  <div id="article_comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_identifier = "posts/2026/02/01/keep-apt-cache.html";
        (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = '//porfiriopaizsite.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
         })();
    </script>
  </div>

</article>


    <div id="ending_message">
      <p>&copy; Porfirio PÃ¡iz. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
  <script>
    const toggleButton = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    
    function updateIcon(theme) {
      themeIcon.textContent = theme === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
    }

    const currentTheme = document.documentElement.getAttribute('data-theme');
    updateIcon(currentTheme);

    toggleButton.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateIcon(newTheme);
    });
  </script>
</body>
</html>