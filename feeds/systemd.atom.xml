<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>porfirio's blog - systemd</title><link href="https://porfiriopaiz.github.io/site/" rel="alternate"/><link href="https://porfiriopaiz.github.io/site/feeds/systemd.atom.xml" rel="self"/><id>https://porfiriopaiz.github.io/site/</id><updated>2026-02-01T15:00:00-06:00</updated><entry><title>Keeping Your APT Package Cache Persistent</title><link href="https://porfiriopaiz.github.io/site/posts/2026/02/01/keep-apt-cache.html" rel="alternate"/><published>2026-02-01T15:00:00-06:00</published><updated>2026-02-01T15:00:00-06:00</updated><author><name>Porfirio Páiz</name></author><id>tag:porfiriopaiz.github.io,2026-02-01:/site/posts/2026/02/01/keep-apt-cache.html</id><summary type="html">&lt;p class="first last"&gt;How to prevent Debian from automatically clearing the
/var/cache/apt/archives directory and disable automated updates.&lt;/p&gt;
</summary><content type="html">&lt;p&gt;If &lt;tt class="docutils literal"&gt;/var/cache/apt/archives&lt;/tt&gt; is empty, it usually means your system is
configured to clean up automatically to save disk space. While this keeps the
system lean, it’s frustrating if you wanted to keep those .deb files for
backups or offline installs.&lt;/p&gt;
&lt;p&gt;Here is how to find the culprit and fix it.&lt;/p&gt;
&lt;hr class="docutils" /&gt;
&lt;div class="section" id="check-the-keep-downloaded-packages-setting"&gt;
&lt;h2&gt;Check the &amp;quot;Keep-Downloaded-Packages&amp;quot; Setting&lt;/h2&gt;
&lt;p&gt;Modern Debian/Ubuntu systems often have a specific configuration that deletes
packages immediately after installation. You need to ensure this is set to
&lt;tt class="docutils literal"&gt;true&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;You can create or edit the configuration file using this &lt;tt class="docutils literal"&gt;sed&lt;/tt&gt; command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;touch&lt;span class="w"&gt; &lt;/span&gt;/etc/apt/apt.conf.d/01keep-debs&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;sed&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;1i Binary::apt::APT::Keep-Downloaded-Packages &amp;quot;true&amp;quot;;&amp;#39;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/etc/apt/apt.conf.d/01keep-debs&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# Force APT to retain downloaded .deb files&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="admonition note"&gt;
&lt;p class="first admonition-title"&gt;Note&lt;/p&gt;
&lt;p class="last"&gt;If this is set to &lt;tt class="docutils literal"&gt;false&lt;/tt&gt; (or &lt;tt class="docutils literal"&gt;0&lt;/tt&gt;), APT deletes the files as soon as the
installation finishes.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;hr class="docutils" /&gt;
&lt;div class="section" id="disable-periodic-cleaning-and-automation"&gt;
&lt;h2&gt;Disable Periodic Cleaning and Automation&lt;/h2&gt;
&lt;p&gt;Debian has a background service called &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;apt-daily&lt;/span&gt;&lt;/tt&gt; that handles automated package maintenance. Even if you tell APT to keep files, the daily maintenance script might be sweeping them away. Modern versions rely on &lt;strong&gt;systemd timers&lt;/strong&gt; rather than traditional cron jobs.&lt;/p&gt;
&lt;div class="section" id="understanding-apt-timers"&gt;
&lt;h3&gt;Understanding APT Timers&lt;/h3&gt;
&lt;p&gt;The key components are:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;strong&gt;apt-daily.timer&lt;/strong&gt;: Triggers the background refresh of package lists.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;apt-daily-upgrade.timer&lt;/strong&gt;: Triggers the actual download and installation of updates.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Check the status of these timers with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;systemctl&lt;span class="w"&gt; &lt;/span&gt;status&lt;span class="w"&gt; &lt;/span&gt;apt-daily.timer&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# Verify if the daily refresh timer is active&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="manual-configuration-via-apt-files"&gt;
&lt;h3&gt;Manual Configuration via APT Files&lt;/h3&gt;
&lt;p&gt;To ensure configurations are applied regardless of the current state of the file, we use a logic that checks for the file's existence, creates it if missing, and ensures the specific lines are either updated or appended.&lt;/p&gt;
&lt;p&gt;For the standard periodic settings in &lt;tt class="docutils literal"&gt;10periodic&lt;/tt&gt;, use the following block:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;FILE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/etc/apt/apt.conf.d/10periodic
sudo&lt;span class="w"&gt; &lt;/span&gt;touch&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$FILE&lt;/span&gt;
grep&lt;span class="w"&gt; &lt;/span&gt;-q&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;APT::Periodic::MaxAge&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$FILE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;sed&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;s/APT::Periodic::MaxAge &amp;quot;.*&amp;quot;/APT::Periodic::MaxAge &amp;quot;0&amp;quot;;/&amp;#39;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$FILE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;||&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;APT::Periodic::MaxAge &amp;quot;0&amp;quot;;&amp;#39;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;tee&lt;span class="w"&gt; &lt;/span&gt;-a&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$FILE&lt;/span&gt;
grep&lt;span class="w"&gt; &lt;/span&gt;-q&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;APT::Periodic::MaxSize&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$FILE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;sed&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;s/APT::Periodic::MaxSize &amp;quot;.*&amp;quot;/APT::Periodic::MaxSize &amp;quot;0&amp;quot;;/&amp;#39;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$FILE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;||&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;APT::Periodic::MaxSize &amp;quot;0&amp;quot;;&amp;#39;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;tee&lt;span class="w"&gt; &lt;/span&gt;-a&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$FILE&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This logic ensures that if the file is missing, it is created; if the lines exist, they are edited to &amp;quot;0&amp;quot;; and if the file exists but lacks these lines, they are appended.&lt;/p&gt;
&lt;p&gt;Next, to explicitly force the deactivation of all automated functions, create or update the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;20auto-upgrades&lt;/span&gt;&lt;/tt&gt; file:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;tee&lt;span class="w"&gt; &lt;/span&gt;/etc/apt/apt.conf.d/20auto-upgrades&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;lt;&amp;lt;EOF&lt;/span&gt;
&lt;span class="s"&gt;APT::Periodic::Update-Package-Lists &amp;quot;0&amp;quot;;&lt;/span&gt;
&lt;span class="s"&gt;APT::Periodic::Download-Upgradeable-Packages &amp;quot;0&amp;quot;;&lt;/span&gt;
&lt;span class="s"&gt;APT::Periodic::AutocleanInterval &amp;quot;0&amp;quot;;&lt;/span&gt;
&lt;span class="s"&gt;APT::Periodic::Unattended-Upgrade &amp;quot;0&amp;quot;;&lt;/span&gt;
&lt;span class="s"&gt;EOF&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="deactivating-systemd-timers"&gt;
&lt;h3&gt;Deactivating Systemd Timers&lt;/h3&gt;
&lt;p&gt;Even with the configurations set to zero, systemd timers will still attempt to trigger services. To stop these triggers entirely:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;systemctl&lt;span class="w"&gt; &lt;/span&gt;disable&lt;span class="w"&gt; &lt;/span&gt;--now&lt;span class="w"&gt; &lt;/span&gt;apt-daily.timer&lt;span class="w"&gt; &lt;/span&gt;apt-daily-upgrade.timer&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# Stop and disable background APT timers&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="final-verification"&gt;
&lt;h3&gt;Final Verification&lt;/h3&gt;
&lt;p&gt;To confirm that the system will no longer perform automated actions, execute:&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;strong&gt;Check APT Configuration&lt;/strong&gt;:
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;apt-config&lt;/span&gt; dump | grep Periodic&lt;/tt&gt; (All variables should be &amp;quot;0&amp;quot;).&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Check Active Timers&lt;/strong&gt;:
&lt;tt class="docutils literal"&gt;systemctl &lt;span class="pre"&gt;list-timers&lt;/span&gt; | grep apt&lt;/tt&gt; (Should return no results).&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;hr class="docutils" /&gt;
&lt;div class="section" id="check-for-no-cache-configuration"&gt;
&lt;h2&gt;Check for &amp;quot;No-Cache&amp;quot; Configuration&lt;/h2&gt;
&lt;p&gt;Some cloud-images or &amp;quot;minimal&amp;quot; installs include a file that redirects the
cache to &lt;tt class="docutils literal"&gt;/dev/null&lt;/tt&gt;.&lt;/p&gt;
&lt;div class="section" id="identify-problematic-files"&gt;
&lt;h3&gt;Identify Problematic Files&lt;/h3&gt;
&lt;p&gt;Check if you have a file named &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;/etc/apt/apt.conf.d/docker-clean&lt;/span&gt;&lt;/tt&gt; (even if
you aren't in a Docker container) or similar. If you see that line, you can
comment it out using &lt;tt class="docutils literal"&gt;sed&lt;/tt&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;/etc/apt/apt.conf.d/docker-clean&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;sed&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/Dir::Cache::Archives/s/^/#/&amp;#39;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/etc/apt/apt.conf.d/docker-clean&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# Deactivate dev/null redirect&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;hr class="docutils" /&gt;
&lt;div class="section" id="verify-directory-permissions"&gt;
&lt;h2&gt;Verify Directory Permissions&lt;/h2&gt;
&lt;p&gt;If the directory permissions are incorrect, APT cannot write the files there. Ensure the directory is owned by &lt;strong&gt;root&lt;/strong&gt; but accessible to the &lt;strong&gt;_apt&lt;/strong&gt; user.&lt;/p&gt;
&lt;p&gt;Run the following to reset permissions:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;chown&lt;span class="w"&gt; &lt;/span&gt;root:root&lt;span class="w"&gt; &lt;/span&gt;/var/cache/apt/archives
sudo&lt;span class="w"&gt; &lt;/span&gt;chmod&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;755&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/var/cache/apt/archives
sudo&lt;span class="w"&gt; &lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;-p&lt;span class="w"&gt; &lt;/span&gt;/var/cache/apt/archives/partial
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;hr class="docutils" /&gt;
&lt;div class="section" id="summary-of-the-apt-cache-path"&gt;
&lt;h2&gt;Summary of the APT Cache Path&lt;/h2&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="46%" /&gt;
&lt;col width="54%" /&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head"&gt;Folder&lt;/th&gt;
&lt;th class="head"&gt;Purpose&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;/var/cache/apt/archives&lt;/td&gt;
&lt;td&gt;Where completed .deb downloads are
stored.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;/var/cache/apt/archives/partial&lt;/td&gt;
&lt;td&gt;Where files sit during the download
process.&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;hr class="docutils" /&gt;
&lt;div class="section" id="how-to-test-your-changes"&gt;
&lt;h2&gt;How to Test Your Changes&lt;/h2&gt;
&lt;p&gt;After making these changes, try downloading a package without installing it
to verify the cache is working:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt&lt;span class="w"&gt; &lt;/span&gt;update
sudo&lt;span class="w"&gt; &lt;/span&gt;apt&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;--download-only&lt;span class="w"&gt; &lt;/span&gt;wget
ls&lt;span class="w"&gt; &lt;/span&gt;/var/cache/apt/archives&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;grep&lt;span class="w"&gt; &lt;/span&gt;wget
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;By following these steps, you gain absolute manual control over your system,
preventing unexpected resource blocks and ensuring your local package archive
remains persistent for offline use!&lt;/p&gt;
&lt;/div&gt;
</content><category term="floss"/><category term="apt"/><category term="cache"/><category term="debian"/><category term="systemd"/></entry></feed>